#!/bin/bash

show_help()
{
  echo "
Usage: ./configure [options]

Options:

  -h, --help                display this help and exit
      --config-NAME         use the configuration script config_NAME.sh
                            to generate the Makefile
                            i.e. '--config-x86-linux-gcc' will generate a
                            makefile based on 'config_x86-linux-gcc.sh'
                            [--config-default]"
    for CONFIGSCRIPT in $(find -maxdepth 1 -type f -name 'config_*.sh')
    do
        #if [ $CONFIGSCRIPT != "./config_default.sh" ]
        #then
            echo "      $(echo $CONFIGSCRIPT | sed 's|.*config_|--config-|g;s|\.sh||g')"
        #fi
    done
    echo "
      --prefix=\"DIRECTORY\"  install distribution files in DIRECTORY
                            [/usr/local]
"

  # http://www.gnu.org/prep/standards/html_node/Configuration.html
  # http://www.sourceware.org/autobook/autobook/autobook_17.html#SEC17
  # http://www.gnu.org/software/automake/manual/html_node/Cross_002dCompilation.html

  exit
}

check_command()
{
    $@ >/dev/null 2>&1
    if [ $? = 0 ]
    then
        $ECHO_ESC "$AF_GREEN ok $AF_RESET"
    else
        $ECHO_ESC "$AF_RED failed $AF_RESET"
        return 1
    fi
}

check_env()
{
    printf "  checking sh ... "
    ECHO_NOLB="printf"
    ECHO_ESC="echo"
    if [ -n "$BASH_VERSION" ]
    then
        ECHO_ESC="echo -e"
        $ECHO_ESC "\033[32mbash\033[0m"
    elif [ -n "$ZSH_VERSION" ]
    then
        ECHO_ESC="echo"
        $ECHO_ESC "\033[31mzsh\033[0m"
        return 1
    else
        ECHO_ESC="echo"
        $ECHO_ESC "\033[33munknown\033[0m"
    fi

    tput -V >/dev/null 2>&1
    if [ $? = 0 ]
    then
        AF_RED=$(tput setaf 1)
        AF_GREEN=$(tput setaf 2)
        AF_YELLOW=$(tput setaf 3)
        AF_RESET=$(tput sgr0)
    else
        AF_RED=$($ECHO_ESC "\033[31m")
        AF_GREEN=$($ECHO_ESC "\033[32m")
        AF_YELLOW=$($ECHO_ESC "\033[33m")
        AF_RESET=$($ECHO_ESC "\033[0m")
    fi

    #$ECHO_NOLB "  checking chmod ... "
    #check_command "chmod --version"

    #$ECHO_NOLB "  checking wc ... "
    #check_command "wc --version"

    $ECHO_NOLB "  checking find ... "
    check_command "find --version"

    $ECHO_NOLB "  checking du ... "
    check_command "du --version"

    $ECHO_NOLB "  checking grep ... "
    check_command "grep --version"

    $ECHO_NOLB "  checking sed ... "
    check_command "sed --version"

    $ECHO_NOLB "  checking sort ... "
    check_command "sort --version"

    $ECHO_NOLB "  checking uniq ... "
    check_command "uniq --version"

    #$ECHO_NOLB "  checking uname ... "
    #check_command "uname --version"

    $ECHO_NOLB "  checking tar ... "
    check_command "tar --version"

    $ECHO_NOLB "  checking make ... "
    check_command "make --version"

    $ECHO_NOLB "  checking gcc ... "
    check_command "gcc --version"

    $ECHO_NOLB "  checking ld ... "
    check_command "ld --version"
}

default_config()
{
    PKGNAME="no-name"
    PKGVERSION="1.0"
    PKGSECTION="none"
    PKGAUTHOR="nobody <nobody@nowhere>"
    PKGHOMEPAGE="http://"
    PKGDEPENDS=""
    PKGDESCRIPTION="Title
 Description"
    SRCPATTERN="*.c *.cc *.c++ *.cxx *.cpp"
    SRCDIR="src"
    RCPATTERN="*.rc"
    RCDIR="res"
    OBJDIR="obj"
    DISTROOT=""
    BINFILE="bin/no-name"
    CC="gcc"
    CFLAGS="-c -Wall -O2"
    RC=""
    RCFLAGS=""
    LD="gcc"
    LDFLAGS="-s"
    LDLIBS=""
}

load_config()
{
    $ECHO_NOLB "  checking file access ... "
    if [ -f $CONFIGSCRIPT ]
    then
        echo "$AF_GREEN ok $AF_RESET"
        . $CONFIGSCRIPT
    else
        echo "$AF_RED failed $AF_RESET"
        return 1
    fi

    $ECHO_NOLB "  checking source directory ($SRCDIR) ... "
    if [ -d "$SRCDIR" ]
    then
        echo "$AF_GREEN ok $AF_RESET"
        $ECHO_NOLB "  checking source files ($SRCPATTERN) ... "
        if [ $(find $SRCDIR -type f -name $(echo $SRCPATTERN | sed -e "s| | -or -name |g") | wc -l) != 0 ]
        then
            echo "$AF_GREEN ok $AF_RESET"
        else
            echo "$AF_RED none found $AF_RESET"
            return 1
        fi
    else
        #mkdir -p "$SRCDIR"
        #if [ -d "$SRCDIR" ]
        #then
        #
        #else
            echo "$AF_RED invalid directory $AF_RESET"
            return 1
        #fi
    fi

    $ECHO_NOLB "  checking object directory ($OBJDIR) ... "
    if [ -d "$OBJDIR" ]
    then
        echo "$AF_GREEN ok $AF_RESET"
    else
        mkdir -p "$OBJDIR"
        if [ -d "$OBJDIR" ]
        then
            echo "$AF_YELLOW not found $AF_RESET -> $AF_GREEN created $AF_RESET"
        else
            echo "$AF_RED invalid directory $AF_RESET"
            return 1
        fi
    fi

    BINPATH=$(echo $BINFILE | sed -e 's|/[^/]*$||g')
    $ECHO_NOLB "  checking binary file path ($BINPATH) ... "
    if [ -d "$BINPATH" ]
    then
        echo "$AF_GREEN ok $AF_RESET"
    else
        mkdir -p "$BINPATH"
        if [ -d "$BINPATH" ]
        then
            echo "$AF_YELLOW not found $AF_RESET -> $AF_GREEN created $AF_RESET"
        else
            echo "$AF_RED invalid path $AF_RESET"
            return 1
        fi
    fi

    $ECHO_NOLB "  checking distribution root ($DISTROOT) ... "
    if [ -d "$DISTROOT" ]
    then
        echo "$AF_GREEN ok $AF_RESET"
        $ECHO_NOLB "  checking distribution content ($DISTROOT/*) ... "
        if [ $(ls $DISTROOT | wc -l) != 0 ]
        then
            echo "$AF_GREEN ok $AF_RESET"
        else
            echo "$AF_YELLOW none found $AF_RESET -> $AF_GREEN ignored $AF_RESET"
            DISTROOT=""
        fi
    else
        echo "$AF_YELLOW invalid directory $AF_RESET -> $AF_GREEN ignored $AF_RESET"
        DISTROOT=""
    fi

    $ECHO_NOLB "  checking compiler ($CC) ... "
    check_command "$CC -v"

    $ECHO_NOLB "  checking includes (-I) ... "
    check_command "ls $(echo '$CFLAGS' | grep -o '\-I\S*' | sed -e 's|-I||g')"

    # NOTE: check for resource compiler disabled because on linux none will be found...
    $ECHO_NOLB "  checking rc-compiler ($RC) ... "
    echo "$AF_YELLOW skipped $AF_RESET"
    #check_command "$RC -V"

    $ECHO_NOLB "  checking rc-includes (-I) ... "
    check_command "ls $(echo '$RCFLAGS' | grep -o '\-I\S*' | sed -e 's|-I||g')"

    $ECHO_NOLB "  checking linker ($LD) ... "
    check_command "$LD -v"

    $ECHO_NOLB "  checking libraries (-L, -l, /*) ... "
    check_command "ld -L/lib -lc $(echo '$LDLIBS' | grep -o '\s\/\S*\|[\-][Ll]\S*') -o null.bin"
    rm -f "null.bin"
}

write_makefile_header()
{
    $ECHO_ESC "# Makefile generated by makebreed" >> $MAKEFILE
    $ECHO_ESC "# http://makebreed.googlecode.com" >> $MAKEFILE
    $ECHO_ESC "" >> $MAKEFILE
    $ECHO_ESC "# Creation Time: '$(date -R -u)'" >> $MAKEFILE
    $ECHO_ESC "" >> $MAKEFILE
}

write_makefile_configuration()
{
    $ECHO_ESC "PKGNAME = $PKGNAME" >> $MAKEFILE
    $ECHO_ESC "PKGVERSION = $PKGVERSION" >> $MAKEFILE
    $ECHO_ESC "PKGSECTION = $PKGSECTION" >> $MAKEFILE
    $ECHO_ESC "PKGAUTHOR = $PKGAUTHOR" >> $MAKEFILE
    $ECHO_ESC "PKGHOMEPAGE = $PKGHOMEPAGE" >> $MAKEFILE
    $ECHO_ESC "PKGDEPENDS = $(echo $PKGDEPENDS | sed -e 's|([^)]*)||g;s|,||g;s|  | |g')" >> $MAKEFILE
    $ECHO_ESC "PKGDESCRIPTION = $PKGDESCRIPTION" | sed 's|$|\\n\\|'>> $MAKEFILE
    $ECHO_ESC " ." >> $MAKEFILE
    $ECHO_ESC "" >> $MAKEFILE
    $ECHO_ESC "SRCPATTERN = $SRCPATTERN" >> $MAKEFILE
    $ECHO_ESC "SRCDIR = $SRCDIR" >> $MAKEFILE
    $ECHO_ESC "RCPATTERN = $RCPATTERN" >> $MAKEFILE
    $ECHO_ESC "RCDIR = $RCDIR" >> $MAKEFILE
    $ECHO_ESC "OBJDIR = $OBJDIR" >> $MAKEFILE

    if [ "$DISTROOT" ]
    then
        $ECHO_ESC "DISTROOT = $DISTROOT" >> $MAKEFILE
    else
        $ECHO_ESC "DISTROOT = /dev/null" >> $MAKEFILE
    fi

    $ECHO_ESC "BINFILE = $BINFILE" >> $MAKEFILE
    $ECHO_ESC "" >> $MAKEFILE
    $ECHO_ESC "CC = $CC" >> $MAKEFILE
    $ECHO_ESC "CFLAGS = $(echo $CFLAGS | sed -e 's|[ ]+| |g')" >> $MAKEFILE
    $ECHO_ESC "RC = $RC" >> $MAKEFILE
    $ECHO_ESC "RCFLAGS = $(echo $RCFLAGS | sed -e 's|[ ]+| |g')" >> $MAKEFILE
    $ECHO_ESC "LD = $LD" >> $MAKEFILE
    $ECHO_ESC "LDFLAGS = $(echo $LDFLAGS | sed -e 's|[ ]+| |g')" >> $MAKEFILE
    $ECHO_ESC "LDLIBS = $(echo $LDLIBS | sed -e 's|[ ]+| |g')" >> $MAKEFILE
    $ECHO_ESC "" >> $MAKEFILE
    $ECHO_ESC "SRCFILES := \$(shell find \$(SRCDIR) -type f -name '' \$(addprefix -or -name , \$(SRCPATTERN)))" >> $MAKEFILE
    $ECHO_ESC "RCFILES := \$(shell find \$(RCDIR) -type f -name '' \$(addprefix -or -name , \$(RCPATTERN)))" >> $MAKEFILE
    $ECHO_ESC "OBJFILES := \$(patsubst \$(SRCDIR)/%, \$(OBJDIR)/%.o, \$(SRCFILES)) \$(patsubst \$(RCDIR)/%, \$(OBJDIR)/%.x, \$(RCFILES))" >> $MAKEFILE
    $ECHO_ESC "DEPFILES := \$(patsubst \$(SRCDIR)/%, \$(OBJDIR)/%.d, \$(SRCFILES)) \$(patsubst \$(RCDIR)/%, \$(OBJDIR)/%.d, \$(RCFILES))" >> $MAKEFILE
    $ECHO_ESC "DISTFILES := \$(patsubst \$(DISTROOT)/%, %, \$(shell find \$(DISTROOT) -type f))" >> $MAKEFILE
    $ECHO_ESC "DISTDIRECTORIES := \$(patsubst \$(DISTROOT)/%, %, \$(shell find \$(DISTROOT) -type d -empty))" >> $MAKEFILE
    $ECHO_ESC "" >> $MAKEFILE
    $ECHO_ESC "DESTDIR = " >> $MAKEFILE
    $ECHO_ESC "PREFIX = $INSTALLDIR" >> $MAKEFILE
    $ECHO_ESC "" >> $MAKEFILE
}

write_makefile_rule_build()
{
    $ECHO_ESC "all: \$(BINFILE)" >> $MAKEFILE
    $ECHO_ESC "" >> $MAKEFILE
    $ECHO_ESC "\$(BINFILE): \$(OBJFILES)" >> $MAKEFILE
    $ECHO_ESC "\t@echo " >> $MAKEFILE
    $ECHO_ESC "\t@\$(shell mkdir -p \$(dir \$@))" >> $MAKEFILE
    # TODO: update for use with ar to create static library files...
    $ECHO_ESC "\t\$(LD) \$(LDFLAGS) -o \$@ \$^ \$(LDLIBS)" >> $MAKEFILE
    $ECHO_ESC "" >> $MAKEFILE
    $ECHO_ESC "\$(CURDIR)/\$(OBJDIR)/%.x \$(CURDIR)/\$(RCDIR)/%.x \$(RCDIR)/%.x: \$(OBJDIR)/%.x" >> $MAKEFILE
    $ECHO_ESC "\$(OBJDIR)/%.x: \$(RCDIR)/%" >> $MAKEFILE
    $ECHO_ESC "\t@echo " >> $MAKEFILE
    $ECHO_ESC "\t@\$(shell mkdir -p \$(dir \$@))" >> $MAKEFILE
    $ECHO_ESC "\t\$(RC) \$(RCFLAGS) -o \$@ -i \$<" >> $MAKEFILE
    # TODO: create a correct dependency file from an rc file... (depends on includes, icons, manifests, ...)
    $ECHO_ESC "\t-@\$(CC) \$(CFLAGS) -MM -MT \$@ \$< > \$(OBJDIR)/\$*.d" >> $MAKEFILE
    $ECHO_ESC "" >> $MAKEFILE
    $ECHO_ESC "\$(CURDIR)/\$(OBJDIR)/%.o \$(CURDIR)/\$(SRCDIR)/%.o \$(SRCDIR)/%.o: \$(OBJDIR)/%.o" >> $MAKEFILE
    $ECHO_ESC "\$(OBJDIR)/%.o: \$(SRCDIR)/%" >> $MAKEFILE
    $ECHO_ESC "\t@echo " >> $MAKEFILE
    $ECHO_ESC "\t@\$(shell mkdir -p \$(dir \$@))" >> $MAKEFILE
    $ECHO_ESC "\t\$(CC) \$(CFLAGS) -o \$@ \$<" >> $MAKEFILE
    $ECHO_ESC "\t-@\$(CC) \$(CFLAGS) -MM -MT \$@ \$< > \$(OBJDIR)/\$*.d" >> $MAKEFILE
    $ECHO_ESC "" >> $MAKEFILE
    $ECHO_ESC "-include \$(DEPFILES)" >> $MAKEFILE
    $ECHO_ESC "" >> $MAKEFILE
}

write_makefile_rule_clean()
{
    $ECHO_ESC "clean:" >> $MAKEFILE
    $ECHO_ESC "\t@rm -f \$(DEPFILES) \$(OBJFILES) \$(BINFILE)" >> $MAKEFILE
    $ECHO_ESC "" >> $MAKEFILE
}

write_makefile_rule_dist_installer()
{
    $ECHO_ESC "install:" >> $MAKEFILE
    $ECHO_ESC "\t@mkdir -p \$(DESTDIR)\$(PREFIX) 2> /dev/null" >> $MAKEFILE
    $ECHO_ESC "\t@cp -v -r \$(DISTROOT)/* \$(DESTDIR)\$(PREFIX)" >> $MAKEFILE
    $ECHO_ESC "" >> $MAKEFILE
    $ECHO_ESC "uninstall:" >> $MAKEFILE
    $ECHO_ESC "\t@rm -v -f \$(addprefix \$(DESTDIR)\$(PREFIX)/, \$(DISTFILES)) 2> /dev/null" >> $MAKEFILE
    $ECHO_ESC "\t@rmdir -p --ignore-fail-on-non-empty \$(addprefix \$(DESTDIR)\$(PREFIX)/, \$(DISTDIRECTORIES)) 2> /dev/null" >> $MAKEFILE
    $ECHO_ESC "\t@rmdir -p --ignore-fail-on-non-empty \$(dir \$(addprefix \$(DESTDIR)\$(PREFIX)/, \$(DISTFILES))) 2> /dev/null" >> $MAKEFILE
    $ECHO_ESC "" >> $MAKEFILE
}

write_makefile_rule_dist_tgz()
{
    $ECHO_ESC "TGZPKG := \$(PKGNAME)-\$(PKGVERSION).tar.gz" >> $MAKEFILE
    $ECHO_ESC "" >> $MAKEFILE
    $ECHO_ESC "tgz:" >> $MAKEFILE
    $ECHO_ESC "\t@tar -czvf \$(TGZPKG) --transform 's,^,\$(PKGNAME)-\$(PKGVERSION)/,' --exclude='make*' --exclude='Make*' --exclude='*.tar.gz' --exclude='*.dsc' --exclude='*.deb' --exclude='\$(BINFILE)' --exclude='\$(OBJDIR)/*' *" >> $MAKEFILE
    $ECHO_ESC "" >> $MAKEFILE
}

write_makefile_rule_dist_dgz()
{
    $ECHO_ESC "DGZPKG := \$(PKGNAME)_\$(PKGVERSION).tar.gz" >> $MAKEFILE
    $ECHO_ESC "" >> $MAKEFILE
    $ECHO_ESC "dgz:" >> $MAKEFILE
    $ECHO_ESC "\t@mkdir -p debian/source 2> /dev/null" >> $MAKEFILE
    $ECHO_ESC "\t@echo '3.0 (native)' > debian/source/format" >> $MAKEFILE
    $ECHO_ESC "\t@echo '\$(PKGNAME) (\$(PKGVERSION)) unstable; urgency=low' > debian/changelog" >> $MAKEFILE
    $ECHO_ESC "\t@echo '' >> debian/changelog" >> $MAKEFILE
    $ECHO_ESC "\t@echo '  [ \$(PKGAUTHOR) ]' >> debian/changelog" >> $MAKEFILE
    $ECHO_ESC "\t@echo '  * \$(PKGNAME) update, details on URL: \$(PKGHOMEPAGE)' >> debian/changelog" >> $MAKEFILE
    $ECHO_ESC "\t@echo '' >> debian/changelog" >> $MAKEFILE
    $ECHO_ESC "\t@echo ' -- \$(PKGAUTHOR)  \$(shell date -R -u)' >> debian/changelog" >> $MAKEFILE
    $ECHO_ESC "\t@echo '8' > debian/compat" >> $MAKEFILE
    $ECHO_ESC "\t@echo 'Source: \$(PKGNAME)' > debian/control" >> $MAKEFILE
    $ECHO_ESC "\t@echo 'Maintainer: \$(PKGAUTHOR)' >> debian/control" >> $MAKEFILE
    $ECHO_ESC "\t@echo 'Section: \$(PKGSECTION)' >> debian/control" >> $MAKEFILE
    $ECHO_ESC "\t@echo 'Priority: optional' >> debian/control" >> $MAKEFILE
    $ECHO_ESC "\t@echo 'Standards-Version: 3.9.3' >> debian/control" >> $MAKEFILE
    $ECHO_ESC "\t@echo 'Build-Depends: debhelper (>=8), \$(RESOLVE_DEV_PKG_DEPS)' | sed -e 's|,\\s*\$\$||g' >> debian/control" >> $MAKEFILE
    $ECHO_ESC "\t@echo '' >> debian/control" >> $MAKEFILE
    $ECHO_ESC "\t@echo 'Package: \$(PKGNAME)' >> debian/control" >> $MAKEFILE
    $ECHO_ESC "\t@echo 'Architecture: any' >> debian/control" >> $MAKEFILE
    $ECHO_ESC "\t@echo 'Depends: \$\${shlibs:Depends}, \$\${misc:Depends}' | sed -e 's|,\$\$||g' >> debian/control" >> $MAKEFILE
    $ECHO_ESC "\t@echo 'Homepage: \$(PKGHOMEPAGE)' >> debian/control" >> $MAKEFILE
    $ECHO_ESC "\t@echo 'Description: \$(PKGDESCRIPTION)' >> debian/control" >> $MAKEFILE
    if [ -f COPYRIGHT ]
    then
        $ECHO_ESC "\t@cp COPYRIGHT debian/copyright" >> $MAKEFILE
    elif [ -f LICENSE ]
    then
        $ECHO_ESC "\t@cp LICENSE debian/copyright" >> $MAKEFILE
    else
        $ECHO_ESC "\t@echo 'UNKNOWN LICENSE' > debian/copyright" >> $MAKEFILE
        $ECHO_ESC "\t@echo '' >> debian/copyright" >> $MAKEFILE
        $ECHO_ESC "\t@echo 'Copyright (c) $(date +%Y) $PKGAUTHOR' >> debian/copyright" >> $MAKEFILE
        $ECHO_ESC "\t@echo 'This Software was build without any license.' >> debian/copyright" >> $MAKEFILE
        $ECHO_ESC "\t@echo 'Please contact the author for further information.' >> debian/copyright" >> $MAKEFILE
    fi
    $ECHO_ESC "\t@echo '#!/usr/bin/make -f' > debian/rules" >> $MAKEFILE
    $ECHO_ESC "\t@echo '' >> debian/rules" >> $MAKEFILE
    $ECHO_ESC "\t@echo '%:' >> debian/rules" >> $MAKEFILE
    $ECHO_ESC "\t@echo '\tdh \$\$@' >> debian/rules" >> $MAKEFILE
    $ECHO_ESC "\t@echo '' >> debian/rules" >> $MAKEFILE
    $ECHO_ESC "\t@echo 'override_dh_auto_install:' >> debian/rules" >> $MAKEFILE
    $ECHO_ESC "\t@echo '\t\$\$(MAKE) DESTDIR=\$\$\$\$(pwd)/debian/\$(PKGNAME) PREFIX=/usr install' >> debian/rules" >> $MAKEFILE
    $ECHO_ESC "\t@chmod 0755 debian/rules" >> $MAKEFILE
    $ECHO_ESC "\t@echo '#!/bin/sh' > debian/postinst" >> $MAKEFILE
    $ECHO_ESC "\t@echo '' >> debian/postinst" >> $MAKEFILE
    $ECHO_ESC "\t@echo 'set -e' >> debian/postinst" >> $MAKEFILE
    $ECHO_ESC "\t@echo 'if [ -x /usr/bin/update-menus ] ; then update-menus ; fi' >> debian/postinst" >> $MAKEFILE
    $ECHO_ESC "\t@echo 'if [ -x /usr/bin/update-mime ] ; then update-mime ; fi' >> debian/postinst" >> $MAKEFILE
    $ECHO_ESC "\t@echo '' >> debian/postinst" >> $MAKEFILE
    $ECHO_ESC "\t@echo '#DEBHELPER#' >> debian/postinst" >> $MAKEFILE
    $ECHO_ESC "\t@chmod 0755 debian/postinst" >> $MAKEFILE
    $ECHO_ESC "\t@echo '#!/bin/sh' > debian/postrm" >> $MAKEFILE
    $ECHO_ESC "\t@echo '' >> debian/postrm" >> $MAKEFILE
    $ECHO_ESC "\t@echo 'set -e' >> debian/postrm" >> $MAKEFILE
    $ECHO_ESC "\t@echo 'if [ -x /usr/bin/update-menus ] ; then update-menus ; fi' >> debian/postrm" >> $MAKEFILE
    $ECHO_ESC "\t@echo 'if [ -x /usr/bin/update-mime ] ; then update-mime ; fi' >> debian/postrm" >> $MAKEFILE
    $ECHO_ESC "\t@echo '' >> debian/postrm" >> $MAKEFILE
    $ECHO_ESC "\t@echo '#DEBHELPER#' >> debian/postrm" >> $MAKEFILE
    $ECHO_ESC "\t@chmod 0755 debian/postrm" >> $MAKEFILE
    $ECHO_ESC "\t@tar -czvf \$(DGZPKG) --transform 's,^,\$(PKGNAME)-\$(PKGVERSION)/,' --exclude='make*' --exclude='Make*' --exclude='*.tar.gz' --exclude='*.dsc' --exclude='*.deb' --exclude='*.lib' --exclude='*.a' --exclude='\$(BINFILE)' --exclude='\$(OBJDIR)/*' *" >> $MAKEFILE
    $ECHO_ESC "" >> $MAKEFILE
}

write_makefile_rule_dist_dsc()
{
    $ECHO_ESC "DSCFILE := \$(PKGNAME)_\$(PKGVERSION).dsc" >> $MAKEFILE
    $ECHO_ESC "" >> $MAKEFILE
    $ECHO_ESC "dsc: dgz" >> $MAKEFILE
    $ECHO_ESC "\t@echo 'Format: 3.0 (native)' > \$(DSCFILE)" >> $MAKEFILE
    $ECHO_ESC "\t@echo 'Source: \$(PKGNAME)' >> \$(DSCFILE)" >> $MAKEFILE
    $ECHO_ESC "\t@echo 'Binary: \$(PKGNAME)' >> \$(DSCFILE)" >> $MAKEFILE
    $ECHO_ESC "\t@echo 'Architecture: any' >> \$(DSCFILE)" >> $MAKEFILE
    $ECHO_ESC "\t@echo 'Version: \$(PKGVERSION)' >> \$(DSCFILE)" >> $MAKEFILE
    $ECHO_ESC "\t@echo 'Maintainer: \$(PKGAUTHOR)' >> \$(DSCFILE)" >> $MAKEFILE
    $ECHO_ESC "\t@echo 'Standards-Version: 3.9.3' >> \$(DSCFILE)" >> $MAKEFILE
    $ECHO_ESC "\t@echo 'Build-Depends: debhelper (>=8), \$(RESOLVE_DEV_PKG_DEPS)' | sed -e 's|,\\s*\$\$||g' >> \$(DSCFILE)" >> $MAKEFILE
    $ECHO_ESC "\t@echo 'Package-List:' >> \$(DSCFILE)" >> $MAKEFILE
    $ECHO_ESC "\t@echo ' \$(PKGNAME) deb \$(PKGSECTION) optional' >> \$(DSCFILE)" >> $MAKEFILE
    $ECHO_ESC "\t@echo 'Checksums-Sha1:' >> \$(DSCFILE)" >> $MAKEFILE
    $ECHO_ESC "\t@echo ' \$(shell sha1sum \$(DGZPKG) | cut -b-40) \$(shell du -b \$(DGZPKG) | sed -e 's|\s*\$(DGZPKG)||g') \$(DGZPKG)' >> \$(DSCFILE)" >> $MAKEFILE
    $ECHO_ESC "\t@echo 'Checksums-Sha256:' >> \$(DSCFILE)" >> $MAKEFILE
    $ECHO_ESC "\t@echo ' \$(shell sha256sum \$(DGZPKG) | cut -b-64) \$(shell du -b \$(DGZPKG) | sed -e 's|\s*\$(DGZPKG)||g') \$(DGZPKG)' >> \$(DSCFILE)" >> $MAKEFILE
    $ECHO_ESC "\t@echo 'Files:' >> \$(DSCFILE)" >> $MAKEFILE
    $ECHO_ESC "\t@echo ' \$(shell md5sum \$(DGZPKG) | cut -b-32) \$(shell du -b \$(DGZPKG) | sed -e 's|\s*\$(DGZPKG)||g') \$(DGZPKG)' >> \$(DSCFILE)" >> $MAKEFILE
    $ECHO_ESC "\t-@lintian" >> $MAKEFILE
    $ECHO_ESC "\t@rm -f -r debian" >> $MAKEFILE
    $ECHO_ESC "" >> $MAKEFILE
}

write_makefile_rule_dist_deb()
{
    $ECHO_ESC "DEBPKG := \$(PKGNAME)_\$(PKGVERSION)_\$(shell dpkg --print-architecture).deb" >> $MAKEFILE
    $ECHO_ESC "" >> $MAKEFILE
    $ECHO_ESC "deb: all" >> $MAKEFILE
    $ECHO_ESC "\t@mkdir -p deb/\$(patsubst /%,%,\$(DESTDIR)\$(PREFIX)) 2> /dev/null" >> $MAKEFILE
    $ECHO_ESC "\t@mkdir -p deb/DEBIAN 2> /dev/null" >> $MAKEFILE
    $ECHO_ESC "\t@cp -r \$(DISTROOT)/* deb/\$(patsubst /%,%,\$(DESTDIR)\$(PREFIX))" >> $MAKEFILE
    $ECHO_ESC "\t@md5sum \$(shell find \$(DISTROOT) -type f) | sed 's|\$(DISTROOT)|\$(patsubst /%,%,\$(DESTDIR)\$(PREFIX))|g' > deb/DEBIAN/md5sums" >> $MAKEFILE
    $ECHO_ESC "\t@echo 'Package: \$(PKGNAME)' > deb/DEBIAN/control" >> $MAKEFILE
    $ECHO_ESC "\t@echo 'Version: \$(PKGVERSION)' >> deb/DEBIAN/control" >> $MAKEFILE
    $ECHO_ESC "\t@echo 'Section: \$(PKGSECTION)' >> deb/DEBIAN/control" >> $MAKEFILE
    $ECHO_ESC "\t@echo 'Architecture: \$(shell dpkg --print-architecture)' >> deb/DEBIAN/control" >> $MAKEFILE
    $ECHO_ESC "\t@echo 'Installed-Size: \$(shell du -k -c \$(DISTROOT) | grep 'total' | sed -e 's|\s*total||g')' >> deb/DEBIAN/control" >> $MAKEFILE
    $ECHO_ESC "\t@echo 'Depends: \$(RESOLVE_BIN_PKG_DEPS)' | sed -e 's|,\\s*\$\$||g' >> deb/DEBIAN/control" >> $MAKEFILE
    $ECHO_ESC "\t@echo 'Maintainer: \$(PKGAUTHOR)' >> deb/DEBIAN/control" >> $MAKEFILE
    $ECHO_ESC "\t@echo 'Priority: optional' >> deb/DEBIAN/control" >> $MAKEFILE
    $ECHO_ESC "\t@echo 'Homepage: \$(PKGHOMEPAGE)' >> deb/DEBIAN/control" >> $MAKEFILE
    $ECHO_ESC "\t@echo 'Description: \$(PKGDESCRIPTION)' >> deb/DEBIAN/control" >> $MAKEFILE
    $ECHO_ESC "\t@echo '#!/bin/sh' > deb/DEBIAN/postinst" >> $MAKEFILE
    $ECHO_ESC "\t@echo '' >> deb/DEBIAN/postinst" >> $MAKEFILE
    $ECHO_ESC "\t@echo 'if [ -x /usr/bin/update-menus ] ; then update-menus ; fi' >> deb/DEBIAN/postinst" >> $MAKEFILE
    $ECHO_ESC "\t@echo 'if [ -x /usr/bin/update-mime ] ; then update-mime ; fi' >> deb/DEBIAN/postinst" >> $MAKEFILE
    $ECHO_ESC "\t@chmod 0755 deb/DEBIAN/postinst" >> $MAKEFILE
    $ECHO_ESC "\t@echo '#!/bin/sh' > deb/DEBIAN/postrm" >> $MAKEFILE
    $ECHO_ESC "\t@echo '' >> deb/DEBIAN/postrm" >> $MAKEFILE
    $ECHO_ESC "\t@echo 'if [ -x /usr/bin/update-menus ] ; then update-menus ; fi' >> deb/DEBIAN/postrm" >> $MAKEFILE
    $ECHO_ESC "\t@echo 'if [ -x /usr/bin/update-mime ] ; then update-mime ; fi' >> deb/DEBIAN/postrm" >> $MAKEFILE
    $ECHO_ESC "\t@chmod 0755 deb/DEBIAN/postrm" >> $MAKEFILE
    $ECHO_ESC "\t@rm -f \$(DEBPKG)" >> $MAKEFILE
    $ECHO_ESC "\t@dpkg-deb -v -b deb \$(DEBPKG)" >> $MAKEFILE
    $ECHO_ESC "\t@rm -f -r deb" >> $MAKEFILE
    $ECHO_ESC "\t-@lintian \$(DEBPKG)" >> $MAKEFILE
    $ECHO_ESC "" >> $MAKEFILE
}

write_makefile_dependency_resolver()
{
    $ECHO_ESC "# BEGIN: deb package dependency resolving block" >> $MAKEFILE
    $ECHO_ESC "# {" >> $MAKEFILE
    $ECHO_ESC "    # return the version for the given package" >> $MAKEFILE
    $ECHO_ESC "    GET_PKG_VERSION = \$(shell dpkg -s \$(PACKAGE) 2> /dev/null | grep '^Version:' | sed -e 's|Version: ||g;s|-.*||g')" >> $MAKEFILE
    $ECHO_ESC "" >> $MAKEFILE
    $ECHO_ESC "    # non-escape patterns" >> $MAKEFILE
    $ECHO_ESC "    PATTERN_01 = s|^Depends: ||g;s|([^)]*)||g;s|,||g;s|\|||;s|  | |g" >> $MAKEFILE
    $ECHO_ESC "    PATTERN_02 = ," >> $MAKEFILE
    $ECHO_ESC "    PATTERN_03 = (" >> $MAKEFILE
    $ECHO_ESC "    PATTERN_04 = )" >> $MAKEFILE
    $ECHO_ESC "    PATTERN_05 = (%)" >> $MAKEFILE
    $ECHO_ESC "    PATTERN_06 = =" >> $MAKEFILE
    $ECHO_ESC "    PATTERN_07 = (>= " >> $MAKEFILE
    $ECHO_ESC "" >> $MAKEFILE
    $ECHO_ESC "    # generate a list of required packages for the binary file" >> $MAKEFILE
    $ECHO_ESC "    BIN_PKG_DEPS = \$(sort \$(shell dpkg -S \$(filter /%, \$(shell ldd \$(BINFILE) 2> /dev/null)) 2> /dev/null | sed -e 's|:.*||g'))" >> $MAKEFILE
    $ECHO_ESC "    # generate a list of user defined packages for the binary file" >> $MAKEFILE
    $ECHO_ESC "    USER_PKG_DEPS = \$(PKGDEPENDS)" >> $MAKEFILE
    $ECHO_ESC "    # add user defined packages to required packages" >> $MAKEFILE
    $ECHO_ESC "    BIN_USER_PKG_DEPS = \$(sort \$(BIN_PKG_DEPS) \$(USER_PKG_DEPS))" >> $MAKEFILE
    $ECHO_ESC "    # generate a list of all dependencies for each required package (ignore user defined packages)" >> $MAKEFILE
    $ECHO_ESC "    RECURSIVE_BIN_PKG_DEPS = \$(sort \$(shell dpkg -s \$(BIN_PKG_DEPS) 2> /dev/null | grep '^Depends:' | sed -e \"\$(PATTERN_01)\"))" >> $MAKEFILE
    $ECHO_ESC "    # remove packages which are already included by other packages (recursive dependencies)" >> $MAKEFILE
    $ECHO_ESC "    DISTINCT_BIN_PKG_DEPS = \$(filter-out \$(RECURSIVE_BIN_PKG_DEPS),\$(BIN_USER_PKG_DEPS))" >> $MAKEFILE
    $ECHO_ESC "    # append version information for each package available on the system" >> $MAKEFILE
    $ECHO_ESC "    RESOLVE_BIN_PKG_DEPS = \$(foreach PACKAGE,\$(DISTINCT_BIN_PKG_DEPS),\$(if \$(GET_PKG_VERSION),\$(PACKAGE) \$(PATTERN_07)\$(GET_PKG_VERSION)\$(PATTERN_04),\$(PACKAGE))\$(PATTERN_02))" >> $MAKEFILE
    $ECHO_ESC "" >> $MAKEFILE
    $ECHO_ESC "    # generate a list of required packages for the building process" >> $MAKEFILE
    $ECHO_ESC "    DEV_PKG_DEPS = \$(sort \$(shell dpkg -S \$(patsubst -l%,lib%,\$(filter -l% %.a %.so,\$(LDLIBS))) 2> /dev/null | sed -e 's|:.*||g'))" >> $MAKEFILE
    $ECHO_ESC "    # generate a list of all dependencies for each required package" >> $MAKEFILE
    $ECHO_ESC "    RECURSIVE_DEV_PKG_DEPS = \$(sort \$(shell dpkg -s \$(DEV_PKG_DEPS) 2> /dev/null | grep '^Depends:' | sed -e \"\$(PATTERN_01)\"))" >> $MAKEFILE
    $ECHO_ESC "    # remove packages which are already included by other packages (recursive dependencies)" >> $MAKEFILE
    $ECHO_ESC "    DISTINCT_DEV_PKG_DEPS = \$(filter-out \$(RECURSIVE_DEV_PKG_DEPS),\$(DEV_PKG_DEPS))" >> $MAKEFILE
    $ECHO_ESC "    # append version information for each package available on the system" >> $MAKEFILE
    $ECHO_ESC "    RESOLVE_DEV_PKG_DEPS = \$(foreach PACKAGE,\$(DISTINCT_DEV_PKG_DEPS),\$(if \$(GET_PKG_VERSION),\$(PACKAGE) \$(PATTERN_07)\$(GET_PKG_VERSION)\$(PATTERN_04),\$(PACKAGE))\$(PATTERN_02))" >> $MAKEFILE
    $ECHO_ESC "# }" >> $MAKEFILE
    $ECHO_ESC "# END" >> $MAKEFILE
    $ECHO_ESC "" >> $MAKEFILE
}

# TODO: add iss section for creating inno setup script

######################################
### main entry point of the script ###
######################################

CONFIGSCRIPT=$(pwd)/config_default.sh
INSTALLDIR="/usr/local"
# TODO: change default installation directory for mingw/windows?
#if [ $(uname | grep 'MING.*NT.*') ]
#then
#   INSTALLDIR="/c/Program Files"
#fi
MAKEFILE=$(pwd)/Makefile

# itereate commandline arguments
for ARG in "$@"
do
    case "$ARG" in
        -h)             show_help
                        ;;
        --help)         show_help
                        ;;
        --config-*)     CONFIGSCRIPT=$(pwd)/$(echo $ARG | sed 's|--config-|config_|g').sh
                        ;;
        --prefix=*)     INSTALLDIR=$(echo $ARG | sed 's|--prefix=||g')
                        ;;
    esac
done

rm -f $MAKEFILE

echo
echo "Environment:"
check_env
if [ $? = 0 ]
then
    echo
    echo "Using: $(basename $CONFIGSCRIPT)"
    default_config
    load_config
    if [ $? = 0 ]
    then
        write_makefile_header
        write_makefile_configuration
        write_makefile_rule_build
        write_makefile_rule_clean
        write_makefile_rule_dist_installer
        write_makefile_rule_dist_tgz
        #check_command "dpkg --version"
        dpkg --version >/dev/null 2>&1
        if [ $? = 0 ]
        then
            write_makefile_rule_dist_dgz
            write_makefile_rule_dist_dsc
            write_makefile_rule_dist_deb
            write_makefile_dependency_resolver
        fi
    fi
fi

echo
